<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Production Schedule with Assigned People</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script>
        function enableCheckbox(checkboxId, person) {
        const checkbox = document.getElementById(checkboxId);
            if (person) {
                checkbox.disabled = false;
            } else {
                checkbox.checked = false;  // Uncheck if no person is selected
                checkbox.disabled = true;
            }

            // Automatically submit the form to update the assignment in Linear
            autoSubmit();
        }

        // Function to save the number of printers to local storage
        function saveNumberOfPrinters(printers) {
            localStorage.setItem('numberOfPrinters', printers);
        }

        // Function to retrieve the number of printers from local storage
        function getNumberOfPrinters() {
            return localStorage.getItem('numberOfPrinters') || 1; // Default to 1 printer if none stored
        }

        // Initialize the number of printers from local storage
        let numberOfPrinters = parseInt(getNumberOfPrinters());

        // Update the number of printers in the DOM on page load
        window.onload = function() {
            document.getElementById("printer-count").innerText = numberOfPrinters;
            updateTotals(getCurrentTotals());
        }

        // Function to submit form asynchronously and update assignments
        function autoSubmit() {
        const form = document.getElementById("scheduleForm");
        const formData = new FormData(form);

        console.log("FormData before submission:");
        formData.forEach((value, key) => {
            console.log(key + ': ' + value);
        });

        fetch(form.action, {
            method: form.method,
            body: formData,
        })
        .then(response => response.json())
        .then(data => {
            console.log(data); // Debugging response data
            // Update the page with the response and totals
            data.schedule.forEach((day) => {
                document.querySelector(`input[name="print1_done_${day['day']}"]`).checked = day['print1_done'] === 1;
                document.querySelector(`input[name="print2_done_${day['day']}"]`).checked = day['print2_done'] === 1;
                document.querySelector(`input[name="print3_done_${day['day']}"]`).checked = day['print3_done'] === 1;
            });

            updateTotals(data.totals);
            updateBedChanges(data.bed_changes);  // Update bed changes dynamically
        })
        .catch(error => {
            console.error("Error submitting form:", error);
        });
    }

        // Function to update totals dynamically
        function updateTotals(totals) {
            document.getElementById("total-rails").innerText = totals[0] * numberOfPrinters;
            document.getElementById("total-iphones").innerText = totals[1] * numberOfPrinters;
            document.getElementById("total-logos").innerText = totals[2] * numberOfPrinters;
            document.getElementById("total-knobs").innerText = totals[3] * numberOfPrinters;
            document.getElementById("total-ipadbase").innerText = totals[4] * numberOfPrinters;
            document.getElementById("total-snapfits").innerText = totals[5] * numberOfPrinters;
        }

        // Function to update bed changes dynamically
        function updateBedChanges(bedChanges) {
            const bedChangeList = document.getElementById("bed-change-list");
            bedChangeList.innerHTML = ""; // Clear current list

            bedChanges.forEach(change => {
                const li = document.createElement("li");
                li.textContent = `${change.person}: ${change.changes * numberOfPrinters} bed changes`;
                bedChangeList.appendChild(li);
            });
        }

        // Adjust part count
        function adjustPartCount(partId, increment) {
            const partElement = document.getElementById(partId);
            let currentValue = parseInt(partElement.innerText);

            if (!isNaN(currentValue)) {
                const newValue = currentValue + increment;
                partElement.innerText = Math.max(newValue, 0);  // Prevent going below 0
                console.log([...formData.entries()]); // Logs form data
                // Send the updated value to the server asynchronously
                const formData = new FormData();
                formData.append(partId, partElement.innerText);

                fetch("/adjust_part_count", {
                    method: "POST",
                    body: formData,
                })
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        alert("Failed to update part count.");
                    }
                })
                .catch(error => {
                    console.error("Error adjusting part count:", error);
                });
            }
        }

        // Adjust the number of printers and save it to local storage
        function adjustPrinters(increment) {
            numberOfPrinters = Math.max(numberOfPrinters + increment, 1);  // Ensure at least 1 printer
            document.getElementById("printer-count").innerText = numberOfPrinters;
            saveNumberOfPrinters(numberOfPrinters);  // Save to local storage

            // Recalculate totals with the updated number of printers
            updateTotals(getCurrentTotals());
        }

        // Get the current totals displayed on the page
        function getCurrentTotals() {
            return [
                parseInt(document.getElementById("total-rails").innerText) / numberOfPrinters,
                parseInt(document.getElementById("total-iphones").innerText) / numberOfPrinters,
                parseInt(document.getElementById("total-logos").innerText) / numberOfPrinters,
                parseInt(document.getElementById("total-knobs").innerText) / numberOfPrinters,
                parseInt(document.getElementById("total-ipadbase").innerText) / numberOfPrinters,
                parseInt(document.getElementById("total-snapfits").innerText) / numberOfPrinters,
            ];
        }
    </script>
</head>
<body>
    <h1>Production Schedule with Assigned People</h1>

    <div>
        <h2>Number of Printers: 
            <button onclick="adjustPrinters(-1)">-</button>
            <span id="printer-count">1</span>
            <button onclick="adjustPrinters(1)">+</button>
        </h2>
    </div>

    <form method="POST" action="/production/update" id="scheduleForm">
        <table border="1">
            <thead>
                <tr>
                    <th>Day</th>
                    <th>Date</th>
                    <th>12-Hour Print (Print 1)</th>
                    <th>Person (Print 1)</th>
                    <th>6-Hour Print 1</th>
                    <th>Person (Print 2)</th>
                    <th>6-Hour Print 2</th>
                    <th>Person (Print 3)</th>
                </tr>
            </thead>
            <tbody>
                {% for day in schedule %}
                <tr>
                    <td>Day {{ day['day'] }}</td>
                    <td>{{ day['date'] }}</td>
                
                    <!-- Print 1 -->
                    <td>
                        <label for="print1_done_{{ day['day'] }}">Print 1</label>
                        <input type="checkbox" id="print1_done_{{ day['day'] }}" name="print1_done_{{ day['day'] }}" 
                               {% if day['print1_done'] %} checked {% endif %} {% if not day['print1_person'] %} disabled {% endif %} 
                               onchange="autoSubmit()">
                    </td>
                    <td>
                        <select name="print1_person_{{ day['day'] }}" onchange="enableCheckbox('print1_done_{{ day['day'] }}', this.value)">
                            <option value="">--Select Person--</option>
                            {% for person in people %}
                            <option value="{{ person }}" {% if day['print1_person'] == person %} selected {% endif %}>{{ person }}</option>
                            {% endfor %}
                        </select>
                    </td>
                
                    <!-- Print 2 -->
                    <td>
                        <label for="print2_done_{{ day['day'] }}">Print 2</label>
                        <input type="checkbox" id="print2_done_{{ day['day'] }}" name="print2_done_{{ day['day'] }}" 
                               {% if day['print2_done'] %} checked {% endif %} {% if not day['print2_person'] %} disabled {% endif %} 
                               onchange="autoSubmit()">
                    </td>
                    <td>
                        <select name="print2_person_{{ day['day'] }}" onchange="enableCheckbox('print2_done_{{ day['day'] }}', this.value)">
                            <option value="">--Select Person--</option>
                            {% for person in people %}
                            <option value="{{ person }}" {% if day['print2_person'] == person %} selected {% endif %}>{{ person }}</option>
                            {% endfor %}
                        </select>
                    </td>
                
                    <!-- Print 3 -->
                    <td>
                        <label for="print3_done_{{ day['day'] }}">Print 3</label>
                        <input type="checkbox" id="print3_done_{{ day['day'] }}" name="print3_done_{{ day['day'] }}" 
                               {% if day['print3_done'] %} checked {% endif %} {% if not day['print3_person'] %} disabled {% endif %} 
                               onchange="autoSubmit()">
                    </td>
                    <td>
                        <select name="print3_person_{{ day['day'] }}" onchange="enableCheckbox('print3_done_{{ day['day'] }}', this.value)">
                            <option value="">--Select Person--</option>
                            {% for person in people %}
                            <option value="{{ person }}" {% if day['print3_person'] == person %} selected {% endif %}>{{ person }}</option>
                            {% endfor %}
                        </select>
                    </td>
                </tr>
                
                
                {% endfor %}
            </tbody>
        </table>
    </form>
    
    
    <div id="bed-changes">
        <h2>Bed Changes</h2>
        <ul id="bed-change-list">
            {% for change in bed_changes %}
                <li>{{ change['person'] }}: {{ change['changes'] }} bed changes</li>
            {% endfor %}
        </ul>
    </div>

    <h2>Total Parts Produced (Current Cycle):</h2>
    <ul>
        <li>Rails: <span id="total-rails">{{ totals[0] }}</span></li>
        <li>iPhones: <span id="total-iphones">{{ totals[1] }}</span></li>
        <li>Logos: <span id="total-logos">{{ totals[2] }}</span></li>
        <li>Knobs: <span id="total-knobs">{{ totals[3] }}</span></li>
        <li>iPadBase: <span id="total-ipadbase">{{ totals[4] }}</span></li>
        <li>Snapfits: <span id="total-snapfits">{{ totals[5] }}</span></li>
    </ul>

    <!-- Submit to Master Summary Button -->
    <form method="POST" action="{{ url_for('production.submit_master') }}">
        <button class="submit-btn" type="submit">Submit to Master Summary</button>
    </form>

    <!-- Undo Button -->
    <form method="POST" action="{{ url_for('production.undo_last_submission') }}">
        <button class="undo-btn" type="submit">Undo Last Submission</button>
    </form>

    <!-- Restart Schedule Button -->
    <form method="POST" action="{{ url_for('production.restart_schedule') }}">
        <button class="submit-btn" type="submit">Restart Schedule with New Date</button>
    </form>

    <h2>Master Summary (Cumulative Across All Cycles):</h2>
    <table border="1">
        <thead>
            <tr>
                <th>Cycle</th>
                <th>Start Date</th>
                <th>End Date</th>
                <th>Total Rails</th>
                <th>Total iPhones</th>
                <th>Total Logos</th>
                <th>Total Knobs</th>
                <th>Total iPadBase</th>
                <th>Total Snapfits</th>
            </tr>
        </thead>
        <tbody>
            {% for cycle in master_summary %}
            <tr>
                <td>Cycle {{ cycle[0] }}</td>
                <td>{{ cycle[1] }}</td>
                <td>{{ cycle[2] }}</td>
                <td>{{ cycle[3] }}</td>
                <td>{{ cycle[4] }}</td>
                <td>{{ cycle[5] }}</td>
                <td>{{ cycle[6] }}</td>
                <td>{{ cycle[7] }}</td>
                <td>{{ cycle[8] }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</body>
</html>
